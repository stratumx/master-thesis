\chapter{Состав и техническое описание разрабатываемого компонента машинного зрения}
\section{Описание архитектуры разрабатываемой двухкоординатной платформы}

Очевидно, что для разработки и тестирования модульной системы управления необходимо устройство, на котором эту систему можно запускать. В качестве тестирующего стенда разрабатывается установка для селективного отверждения фотополимера, предназначенная для работы с поверхностями любой формы. В основе процесса обработки лежит лазерная обработка, аналог технологии LDS\footnote{Laser Direct Structuring}.

В составе установки находятся: неподвижный рабочий стол, на котором находится обрабатываемый объект\,(заготовка), лазерная головка с возможностью перемещения по двум координатам при помощи шаговых электродвигателей и направляющих, источник лазерного излучения. Лазерная головка снабжена гиростабилизированным подвесом на основе модифицированной платформы Стюарта, перемещения осуществляются с помощью пьезомоторов. Данный подвес позволяет удерживать лазерный луч в фокусе и осуществлять обработку наклонных поверхностей за счёт возможности осуществления наклона источника лазерного излучения и перемещения его~по~координате Z. Ещё одна функция лазерного блока - гашение колебаний, для определения которых применяются одноосевые акселерометры, а~также камера, отслеживающая в реальном времени форму пятна. 

Общее изображение установки представлено в приложении \ref{app:b}. Далее приводится общее описание модулей, из которых состоит система управления установкой\,(рис. \ref{fig:control-system}):

\begin{figure}[t]
	\centering
	\includegraphics[width=0.6\linewidth]{control-system.eps}
	\caption{Структура модулей системы управления установкой}
	\label{fig:control-system}
\end{figure}

\textbf{Коммуникационный модуль\,(CM).} Основное назначение модуля состоит в регистрации и диспетчировании новых модулей и обеспечении устойчивости системы к отказам.

\textbf{Базовый низкоуровневый управляющий контроллер\,(BLLC).} Физически является блоком управления, основные функции: генерация управляющих сигналов для электроприводов координатного стола и обработка сигналов, поступающих от датчиков установки. Интеракция модуля с внешней средой заключается в приёме на вход управляющей программы (G-code\footnote{G-code\,(G-код) -- условное название языка программирования для оборудования с ЧПУ. Утверждён как ГОСТ 20999-83\,(в СССР~\cite{gost20999}) и как стандарт ISO 6983-1:2009\,(в остальном мире~\cite{iso6983}).}), передаче данных от датчиков и непосредственно включением и~выключением источника лазерного излучения, используя для приёма/передачи протокол USART. В остальном процессе работы модуль автономен и способен самостоятельно обрабатывать ошибки и реагировать на них, все действия модуля регистрируются в журнале событий.

Также в некоторых случаях BLLC может принимать одиночные управляющие сигналы, необходимые для взаимодействия установки с оператором. BLLC имеет отладочный управляющий порт USART, посредством которого оператор может подавать на контроллер команды в текстовом виде. Данная функция предусмотрена для реагирования на нештатные ситуации и отладки работы модуля. 

\textbf{Источник лазерного излучения\,(LBS).} Функционал LBS напрямую связан с настройками лазера: включение/выключение, измерение мощности и обработка данных от датчиков. LBS занимает подчинённую роль по отношению к BLLC, но держит с ним постоянную связь, поскольку в~случае нештатной ситуации лазер должен сразу же выключиться во избежание порчи заготовки или пожара. LBS способен обрабатывать исключения самостоятельно, но в некоторых случаях требуется связь с BLLC для подтверждения своих действий.

\textbf{Интеллектуальная лазерная головка\,(SLH).} Его функционал был описан выше: наклон источника лазерного излучения, фокусировка и~компенсация колебаний. Как и остальные модули, обрабатывает события автономно и оповещает сеть при помощи соответствующих сигналов.

\textbf{Модуль машинного зрения\,(MVM).} Основными его функциями являются поиск реперной точки на заготовке и трансляция видеопотока на~пользовательский виджет. Перед запуском управляющей программы на~исполнение MVM по запросу возвращает найденные координаты нулевой точки, после чего переходит в режим ожидания.

\textbf{Модуль интерфейса пользователя\,(UIM).} То, с чем напрямую работает пользователь системы. Представляет собой агрегатор пользовательских панелей (виджетов) и веб-приложение для их отображения. Набор виджетов зависит от типа взаимодействия с другими компонентами. Логика интерфейса прописана в каждом из компонентов и~подгружается в~приложение при необходимости.

\textbf{Модуль подготовки управляющих программ\,(CPPM).} С его помощью выполняется подготовка G-кода в браузере. Физически это веб-приложение, встраиваемое в UIM.

\section{Модуль машинного зрения}\label{razd3-2}

\subsection{Структура компонентов модуля}

С точки зрения холонического подхода к проектированию систем управления, модуль машинного зрения находится в составе \textit{интеллектуального холона} вместе с SLH. Его общая структура и компоненты представлены на рисунке \ref{fig:mvm-struct}. Он содержит две составляющие: модуля управления пьезомоторами и модуля определения положения, которые взаимодействуют между собой. Интеллектуальный блок имеет связь с остальной системой при помощи Wi-Fi модуля, передача данных внутри блока и между блоком и внешними модулями осуществляется с использованием открытой библиотеки коротких сообщений Nanomsg.

Для создания встраиваемых систем нецелесообразно использовать общепринятые библиотеки, применяемые в промышленных решениях. В открытых системах лучшим решением будет использовать преимущества низкоуровневых сокетов в сочетании с маршрутизацией сообщений. Поэтому протокольное сообщение основано на так называемых \textit{очередях сообщений}. Этот протокол является асинхронным, то есть отправитель и получатель взаимодействуют друг с другом только через очередь. В системе применяется два вида сообщений: децентрализованный обмен сообщениями между модулями и широковещательные пакеты.

Поскольку MVM по большей части автономен, а обмен сообщениями происходит лишь в исключительных случаях, то отказ этого компонента критичен только в процессе поиска нулевой точки заготовки. В остальных случаях CM оповещает оператора, что модуль недоступен, а~процесс обработки заготовки при этом не нарушается. Как и остальные крупные модули, данный блок имеет внутреннее хранилище для журнала событий, базы данных и компонентов пользовательского интерфейса.

Сеть испытывает нагрузку лишь в случае передачи потокового видео пользователю, поэтому есть смысл в организации отдельного канала для данной функции. Применение отдельного канала особенно актуально в связи с тем, что BLLC и LBS вынуждены поддерживать обмен сообщениями из соображений безопасности. Таким образом, интеллектуальный блок имеет две связи с остальной системой: через USART с BLLC и через RTSP\footnote{Real Time Streaming Protocol}, специализированным протоколом для передачи видеопотока.

\begin{figure}[t]
	\centering
	\includegraphics[width=0.5\linewidth]{mvm-struct.png}
	\caption{Структура интеллектуального холона}
	\label{fig:mvm-struct}
\end{figure}

\subsection{Состав технических средств}

В качестве приёмного оборудования используется IP-камера с Wi-Fi модулем для обеспечения беспроводной связи для передачи видеопотока. Её характеристики представлены в таблице \ref{tab:ipcamera}.

\begin{table}[h]
\begin{flushleft}
\caption{\label{tab:ipcamera}Характеристики используемой IP-камеры.}
\begin{tabular}{|p{8cm}|p{7.5cm}|}
\hline
\textbf{Параметр} & \textbf{Значение} \\
\hline
Максимальное разрешение, точек & $1280 \times 920$ \\
\hline
Частота кадров, в с. & 25--30 \\
\hline
Диаметр линзы, мм & 8 \\
\hline
Размеры платы, мм & $38\times38$ \\
\hline
Интерфейсы & Wi-Fi, IR-CUT \\
\hline
Тип сенсора & 1/3 ''AR 0130 CMOS \\
\hline
Поддерживаемые виды связи & 10/100M Ethernet / RTSP / PPPoE / FTP / DHCP \\
\hline
Вид сжатия видео & H.264, AVI \\
\hline
\end{tabular}
\end{flushleft}
\end{table}

В качестве контроллера для исполнения обрабатывающей программы используется одноплатный компьютер Odroid-C2. Его характеристики представлены в таблице \ref{tab:odroid}.

\begin{table}[h]
\begin{flushleft}
\caption{\label{tab:odroid}Характеристики Odroid-C2.}
\begin{tabular}{|p{6cm}|p{9.5cm}|}
\hline
\textbf{Параметр} & \textbf{Значение} \\
\hline
Процессор & Amlogic ARM Cortex-A53 1.5 GHz \\
\hline
Память & SDRAM 2048 Mb DDR3 \\
\hline
Графический процессор & ARM Mali-450 MP3 GPU \\
\hline
Кодеки & H.264 30FPS и H.265 60FPS VPU \\
\hline
Размеры, мм & $85\times56\times18$ \\
\hline
\end{tabular}
\end{flushleft}
\end{table}

Тестирование программной реализации обрабатывающего алгоритма проводилось на ноутбуке марки Lenovo B570e со следующими характеристиками\,(таблица \ref{tab:b570e}):

\begin{table}[h]
\begin{flushleft}
\caption{\label{tab:b570e}Характеристики ноутбука Lenovo B570e.}
\begin{tabular}{|p{6cm}|p{9.5cm}|}
\hline
\textbf{Параметр} & \textbf{Значение} \\
\hline
Процессор & Intel Celeron 1.5 GHz dual core \\
\hline
Память & SDRAM 2048 Mb DDR2 \\
\hline
Графический процессор & GeForce GT410M 1024 Mb VRAM \\
\hline
Операционная система & Microsoft Windows 7 x64 \\
\hline
\end{tabular}
\end{flushleft}
\end{table}

Таким образом, можно заметить, что по техническим характеристикам ноутбук близок к одноплатному компьютеру Odroid-C2, поэтому результаты тестирования обработчика можно считать близкими к реальной работе программы. Изображения используемых технических средств представлены в приложении \ref{app:c}.

\subsection{Состав программных средств}

\textbf{Python} -- высокоуровневый язык программирования общего назначения, разработанный Гвидо ван Россумом в 1991 году, с тех пор постоянно улучшается и совершенствуется. Поддерживает написание скриптов, функциональное и объектно-ориентированное программирование. На данный момент существует две параллельные ветви его развития, Python 2.X.X и Python 3.X.X, поскольку между ними имеются фундаментальные различия, что исключает возможность их совместимости.

В ходе работы Python версии 2.7.6 использовался для составления и~отладки алгоритма поиска метки, поскольку данный язык характеризуется наглядностью кода, простотой использования и большим количеством литературы. Версия 2.Х.Х была выбрана по причине того, что~библиотека OpenCV на тот момент ещё не имела стабильной версии для Python 3.X.X. К сожалению, Python не лишён недостатков, и основной среди них -- низкая скорость работы, поэтому для реализации алгоритма лучшим решением будет использовать C.

\textbf{OpenCV} -- библиотека обработки изображений и потокового видео, реализованная для большого количества языков программирования, среди которых есть все основные: C/C++, Java, Python и другие. Данная библиотека имеет множество реализованных алгоритмов, которые достаточно просто встраивать в логику программы, кроме того, она является ПО с~открытым исходным кодом.

Поскольку OpenCV достаточно громоздкое решение для реализации алгоритма на микроконтроллере, данная библиотека также использовалась на этапе отладки алгоритма распознавания.

\section{Практические результаты}

Разработанная управляющая программа была протестирована в работе оборудования. Реальный инструмент в рабочем органе установки был заменён шариковой ручкой. Тесты проводились по следующему сценарию:

\begin{enumerate}
\item Рабочий орган установки с закреплённой на нём камерой выполнял последовательный проход рабочего пространства стола. На столе был размещён лист бумаги А4 с изображением метки. Использовалось несколько листов с разным размером изображения.
\item Как только метка попадает в поле зрения камеры, алгоритм начинает определять, попала ли метка в кадр полностью, для чего проводится вычисление размеров контура. Так как метка круглая, то её длина и~ширина должны быть равны. В алгоритм заложена возможность небольшого отклонения ввиду небольшого разрешения камеры.
\item Если метка попала в кадр полностью, то она подсвечивается на выходном изображении зелёным цветом\,(рис. \ref{fig:result}), после чего программа посылает на вход управляющего контроллера установки сигналы перемещения рабочего органа по координатам, пока центр  кадра не~совпадёт с центром метки. Также программа возвращает координаты первого вхождения метки в кадр.
\item Начинается выполнение тестовой управляющей программы.
\end{enumerate}

В качестве одного из результатов было получено изображение квадрата, одна из вершин которого совпадает с центром реперной метки. Можно заключить, что программа успешно определила метку и использовала её~как~нулевую координату для запуска на выполнение управляющей программы (рис. \ref{fig:result2}).

Также для размещения технических элементов компонента был спроектирован в пакете SolidWorks корпус и в дальнейшем построен на 3D-принтере (приложение \ref{app:c}). При проектировании модели корпуса учитывалось наличие в устройстве охлаждающего вентилятора во избежание перегрева элементов платы камеры.

\begin{figure}[t]
	\centering
	\includegraphics[width=0.8\linewidth]{result2.png}
	\caption{Результат выполнения тестовой программы}
	\label{fig:result2}
\end{figure}

\section{Выводы к третьей главе}

\begin{enumerate}
\item Спроектирована архитектура координатного станка с описанием работы модулей, входящих в его систему управления. Также выбран протокол коммуникации модулей.
\item Описана структура модуля машинного зрения, состав технических и~программных средств, сценарии коммуникации компонентов модуля друг с другом и с внешней средой.
\item Представлены некоторые практические результаты работы, полученные при выполнении тестовых запусков обрабатывающей программы.
\end{enumerate}